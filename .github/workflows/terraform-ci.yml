name: Terraform CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  TF_VERSION: '1.6.0'

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive .
      
      - name: Terraform Init (Main)
        working-directory: terraform
        run: terraform init -backend=false
      
      - name: Terraform Validate (Main)
        working-directory: terraform
        run: terraform validate
      
      - name: Validate Modules
        run: |
          for module in modules/*/; do
            if [ -f "${module}main.tf" ]; then
              echo "Validating ${module}"
              cd "${module}"
              terraform init -backend=false
              terraform validate
              cd -
            fi
          done

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
      
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest
      
      - name: Init TFLint
        run: tflint --init
      
      - name: Run TFLint
        run: tflint --recursive
      
      - name: Setup ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Run ShellCheck
        run: find scripts -name "*.sh" -type f -exec shellcheck {} \;

  docker-validate:
    name: Validate Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Terraform Runner (AMD64)
        run: |
          docker build --platform linux/amd64 \
            -f docker/terraform-runner/Dockerfile \
            -t treza-terraform-runner:test .
      
      - name: Verify Architecture
        run: |
          docker run --rm treza-terraform-runner:test uname -m | grep -q x86_64
          echo "✅ Docker image built for correct architecture (amd64)"

  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        working-directory: tests
        run: |
          pip install -r requirements.txt
      
      - name: Run unit tests
        working-directory: tests
        run: pytest unit/ -v

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Check for required documentation
        run: |
          required_files=(
            "README.md"
            "CHANGELOG.md"
            "DEPLOYMENT_GUIDE.md"
            "ROADMAP.md"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "❌ Missing documentation files: ${missing_files[*]}"
            exit 1
          fi
          
          echo "✅ All required documentation files present"
      
      - name: Check README freshness
        run: |
          if grep -q "TODO" README.md; then
            echo "⚠️  README contains TODO items"
            grep -n "TODO" README.md
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate, security-scan, lint, docker-validate, python-tests, documentation]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "## CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scanning | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Validation | ${{ needs.docker-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.python-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.validate.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.docker-validate.result }}" != "success" ]] || \
             [[ "${{ needs.python-tests.result }}" != "success" ]] || \
             [[ "${{ needs.documentation.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All checks passed successfully!" >> $GITHUB_STEP_SUMMARY

